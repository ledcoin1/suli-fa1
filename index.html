<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mini App ‚Äì Rock Paper Scissors</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: "Inter", sans-serif;
      background: linear-gradient(135deg, #0f0f0f, #1a1a1a);
      color: #fff;
      height: 100vh;
      overflow-x: hidden;
    }

    .container {
      max-width: 420px;
      margin: auto;
      padding: 22px;
      animation: fadeIn 0.7s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px);} 
      to { opacity: 1; transform: translateY(0);} 
    }

    h2 {
      text-align: center;
      font-size: 28px;
      margin-bottom: 10px;
      font-weight: 700;
    }

    .card {
      background: #181818;
      padding: 18px;
      border-radius: 16px;
      box-shadow: 0 0 22px rgba(0,0,0,0.4);
      margin-bottom: 20px;
      transition: 0.3s;
    }

    .card:hover {
      transform: scale(1.02);
    }

    .label {
      opacity: 0.8;
      font-size: 14px;
    }

    .value {
      font-size: 22px;
      font-weight: 600;
      margin-top: 4px;
    }

    input {
      width: 100%;
      padding: 12px;
      font-size: 18px;
      border-radius: 12px;
      border: none;
      outline: none;
      background: #222;
      color: #fff;
      margin-top: 10px;
    }

    .btn {
      width: 100%;
      padding: 14px;
      background: #00c2ff;
      border-radius: 12px;
      margin-top: 18px;
      border: none;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.25s;
    }

    .btn:hover {
      background: #00e0ff;
      transform: translateY(-2px);
    }

    .rps-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }

    .rps-btn {
      width: 30%;
      padding: 16px;
      font-size: 18px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      background: #333;
      transition: 0.25s;
    }
    .rps-btn:hover { background:#444; transform: scale(1.05);}    

    .result-box {
      text-align: center;
      margin-top: 25px;
      font-size: 22px;
      font-weight: 700;
      min-height: 28px;
      animation: fadeIn 0.4s ease;
    }

    #history {
      margin-top: 15px;
      font-size: 14px;
      max-height: 180px;
      overflow-y: auto;
      text-align: left;
    }

    .history-item.win { color: #00ffae; }
    .history-item.lose { color: #ff4d4d; }
    .history-item.draw { color: #e0e0e0; }

  </style>
</head>
<body>
<div class="container">

  <h2>Rock ‚Äì Paper ‚Äì Scissors</h2>

  <div class="card">
    <div class="label">Telegram ID</div>
    <div id="uid" class="value">...</div>
  </div>

  <div class="card">
    <div class="label">Balance</div>
    <div id="balance" class="value">0</div>
    <button class="btn" onclick="loadBalance()">Update Balance</button>
  </div>

  <div class="card">
    <div class="label">Enter Bet</div>
    <input id="bet" type="number" placeholder="Bet..." />
  </div>

  <div class="card">
    <div class="label">Choose:</div>
    <div class="rps-buttons">
      <button class="rps-btn" onclick="play('rock')">ü™®</button>
      <button class="rps-btn" onclick="play('paper')">üìÑ</button>
      <button class="rps-btn" onclick="play('scissors')">‚úÇÔ∏è</button>
    </div>
  </div>

  <div id="result" class="result-box"></div>

  <div class="card">
    <h3>Game History (last 10)</h3>
    <div id="history"></div>
  </div>

</div>

<script>
  const tg = window.Telegram.WebApp;
  tg.expand();

  const user = tg.initDataUnsafe?.user;
  let userId = user?.id || "guest";
  document.getElementById("uid").innerText = userId;

  const SERVER = "https://sulifaaaaaa3server.onrender.com";

  let history = [];

  async function loadBalance() {
    try {
      const res = await fetch(`${SERVER}/balance/${userId}`);
      const data = await res.json();
      animateBalance(data.balance);
    } catch (e) {
      alert("Failed to connect to the server");
    }
  }

  function animateBalance(newVal){
    const el = document.getElementById("balance");
    el.style.transition="0.3s";
    el.style.transform="scale(1.25)";
    setTimeout(()=>{
      el.innerText = newVal;
      el.style.transform="scale(1)";
    },200);
  }

  async function play(choice) {
    const bet = Number(document.getElementById("bet").value);
    if (!bet || bet <= 0) return alert("Enter your bet!");

    // üîπ —Å–µ—Ä–≤–µ—Ä–¥–µ–Ω –±–æ—Ç—Ç—ã“£ —Ä–∞–Ω–¥–æ–º —Ç–∞“£–¥–∞—É—ã–Ω –∞–ª–∞–º—ã–∑
    let botChoice = '';
    try {
      const botRes = await fetch(`${SERVER}/bot_pick`);
      const botData = await botRes.json();
      botChoice = botData.bot;
    } catch(e){
      alert("Failed to get bot choice");
      return;
    }

    const res = await fetch(`${SERVER}/playRPS`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id: userId, bet, choice, bot: botChoice })
    });

    const data = await res.json();

    animateBalance(data.balance);

    const resultEl = document.getElementById("result");
    resultEl.innerHTML = data.result;
    resultEl.style.color = data.win ? "#00ffae" : data.draw ? "#e0e0e0" : "#ff4d4d";

    history.push({
      choice: choice,
      botChoice: botChoice,
      result: data.result,
      bet: bet,
      amountWon: data.win ? bet * 1.85 : 0,
      status: data.win ? 'win' : data.draw ? 'draw' : 'lose'
    });

    if (history.length > 10) history.shift();
    renderHistory();
  }

  function renderHistory() {
    const container = document.getElementById("history");
    container.innerHTML = history.map(h =>
      `<div class='history-item ${h.status}'>Bet: ${h.bet} | You: ${h.choice} | Bot: ${h.botChoice} | Result: ${h.result} | Win: ${h.amountWon}</div>`
    ).join('');
  }

  window.addEventListener("beforeunload", () => { history = []; });

  loadBalance();
</script>
</body>
</html>
